<!DOCTYPE html>
<html lang='en'>
  <head>
  <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> 
    {{#if pageTitle }}
    {{ pageTitle }} || Storybook 
    {{ else}}
     Storybook 
    {{/if}}
    </title>
    
    <link rel="shortcut icon" href="/img/storybook.png" />
    
    <link rel="stylesheet" href="/bootstrap-4.3.1/css/bootstrap-4.3.1.min.css" />
      <link rel="stylesheet" href="/fontawesome-free-5.8.2-web/css/all.css">
      <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/eruda.min.js"></script>
    <script>eruda.init();</script>
    <script src="/js/eruda-code.min.js"></script>
    <script>eruda.add(erudaCode)</script>
    <script src="/js/eruda-dom.min.js"></script>
    <script>eruda.add(erudaDom)</script>
    <!-- ckeditor basic-->
  <script src="//cdn.ckeditor.com/4.12.1/standard/ckeditor.js"></script>
    
  </head>
  <body>
   <!-- navbar partials -->
    {{> _navbar }}
    {{> _msg }}
    {{> _errors }}
   
   <div class="body">
    {{{body}}}
    </div>
    
   {{> _footer }}
   
   
   <!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="/bootstrap-4.3.1/js/jquery-3.4.1.min.js" type="text/javascript"></script>

  <script src="/bootstrap-4.3.1/js/popper.min.js" type="text/javascript"></script>
  <script src="/bootstrap-4.3.1/js/bootstrap-4.3.1.min.js" type="text/javascript"></script>
   
   <script src="/bootstrap-4.3.1/js/bs-custom-file-input.min.js" type="text/javascript"></script>
    <!-- axios -->
    <!--script src="https://unpkg.com/axios/dist/axios.min.js"></script-->
     <script src="/bootstrap-4.3.1/js/axios.min.js" type="text/javascript"></script>
   <!-- main js -->
  <script src="/js/main.js"></script>
  
  <script>
    $(function(){
      console.log('onload')
      
       
      let res = '';
      
   $('form input#profile-image') && $('form input#profile-image').on('change', async function(e) {
     
      const file = $('#profile-image')[0].files[0];
      console.log('on change', file);
      if(!file){
        const the_url = $('#prevAvatar').val();
        display(the_url, 'Profile');
        return;
      } 
     // grab the first image in the FileList object and pass it to the function
     
       renderImage(this.files[0])
     
       
      
     
     
        
        
       // render the image in our view and get presignedUrl
       function renderImage(file) {
       
       // generate a new FileReader object
       var reader = new FileReader();
       
       // inject an image with the src url
       reader.onload = async function(event) {
       the_url = event.target.result;
       display(the_url, 'Preview');
       
       
        const url = '/uploads';
     
     // getPresignedUrl
       res = await axios.get(url, {
        params: {
          filename: file.name, 
          type: file.type,
          }
        });
        console.log(res)
        
       } // end reader.onload
       
       // when the file is read it triggers the onload event above.
       reader.readAsDataURL(file);
       }
      
    }); // end change
    
    
    // on submit
 document.querySelector('form#update') && document.querySelector('form#update')
 .addEventListener('submit', function(e){
        e.preventDefault();
        console.log('submit');
        
        
        let imageName='', url='';
        
        // no presignedUrl
        if(!res){
          e.target.submit();
          return;
        }
        
         ({imageName, url: imageUrl } = res.data);
        
        
        const file = $('#profile-image')[0].files[0];
         if(!file){
           e.target.submit();
          return;
         }
         
         const elem = $(this).find('[type=hidden][name=avatar]');
        elem.val(imageName);
        
        console.log('elem', elem[0], 'file', file)
        console.log('res submit', imageUrl, imageName, );
        
        
        
        
        //const html = loading();
        
        // upload to google buckets
         axios.put(imageUrl, file, { 
        headers: {
           'Content-Type': file.type,
           },
      })
      .then( res => {
        console.log('axios gcp resPre:', res);
        
        
        e.target.submit();
        
      })
      .catch(err => {
        console.log('err getPresignedUrl:', err);
        
        //restore(html)
        
      });
      
        
      }); // end submit
     
     
     
    
    }); // onload
  </script>
  </body>
</html>